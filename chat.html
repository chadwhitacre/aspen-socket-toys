filename = "chat.sock"

<head>
    <title>Greetings, program!</title>
    <style>@import url("/socket-toys.css");</style>
    <style>
        #messages P {
            padding: 0;
        }
    </style>
</head>
<body>
    {% include "header.html" %}

    <p>Your username is <button></button>. Anyone with this page open will see
    your messages.</p>

    <p><input /></p>
    <div id="messages"></div>
</body>
<script src="/jquery-1.6.1.min.js"></script>
<script src="/socket.io.js"></script>
<script>
    var App = {};

    App.send = function(e)
    {
        if (e.which !== 13) // return
        return;

        var data = {}
        data.message = $(this).val();
        data.username = App.$username.text();

        App.socket.json.send(data);

        $(this).val('');

    };

    App.changeUsername = function() 
    {
        var newUsername = prompt("Username?");
        console.log(newUsername);
        if (newUsername !== null && newUsername.trim() !== "")
        {
            var escaped = $('<div>').text(newUsername).html();
            App.$username.text(escaped);
        }
    };

    App.recv = function(data)
    {
        console.log(data);
        App.$messages.append( '<p>'
                            + '<b>'+data.username+'</b>: '
                            + data.message
                            + '</p>' 
                             );
    };

    App.main = function()
    {
        $('.chat').wrap('<b>');

        App.$messages = $('#messages');
        App.$input = $('input');
        App.$input.keyup(App.send);
        App.$input.focus();
        App.$username = $('button');
        App.$username.text('anon-' + Math.floor(Math.random()*101).toString());
        App.$username.click(App.changeUsername);

        App.socket = io.connect( '/chat.sock'
                               , { "resource": "chat.sock"
                                 , "transports": ["xhr-polling"]
                                  }
                                );
        App.socket.on('message', App.recv)
    };

    $(document).ready(App.main);
</script>
